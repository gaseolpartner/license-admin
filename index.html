<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”‘ ê°€ì„¤íŒŒíŠ¸ë„ˆ ë¼ì´ì„ ìŠ¤ ê´€ë¦¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app" class="container mx-auto px-4 py-8 max-w-6xl">
    
    <!-- í—¤ë” -->
    <div class="mb-8 text-center">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ”‘ ê°€ì„¤íŒŒíŠ¸ë„ˆ ë¼ì´ì„ ìŠ¤ ê´€ë¦¬</h1>
      <p class="text-gray-600">ì‹œìŠ¤í…œë¹„ê³„/ë™ë°”ë¦¬ ë¼ì´ì„ ìŠ¤ ë°œê¸‰ ë° ê´€ë¦¬</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <!-- ë°œê¸‰ í¼ -->
      <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-xl font-bold mb-6 text-gray-800">âœ¨ ìƒˆ ë¼ì´ì„ ìŠ¤ ë°œê¸‰</h2>
        
        <form id="licenseForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ê³ ê°ëª… *</label>
            <input type="text" id="customer_name" required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
              placeholder="í™ê¸¸ë™">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">íšŒì‚¬ëª…</label>
            <input type="text" id="company_name"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
              placeholder="(ì£¼)ê°€ì„¤ê±´ì„¤">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">í•˜ë“œì›¨ì–´ ID *</label>
            <input type="text" id="hardware_id" required maxlength="16"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none font-mono uppercase"
              placeholder="A1B2C3D4E5F6G7H8"
              oninput="this.value = this.value.toUpperCase()">
            <p class="text-xs text-gray-500 mt-1">16ìë¦¬ ì˜ìˆ«ì (ê³ ê° í”„ë¡œê·¸ë¨ì—ì„œ í™•ì¸)</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ì—°ë½ì²˜</label>
            <input type="tel" id="customer_phone"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
              placeholder="010-1234-5678">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë©”ì¼</label>
            <input type="email" id="customer_email"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
              placeholder="customer@email.com">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ì œí’ˆ ìœ í˜•</label>
            <select id="product_type"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none">
              <option value="all">ì „ì²´ (ë¹„ê³„+ë™ë°”ë¦¬)</option>
              <option value="scaffold">ì‹œìŠ¤í…œë¹„ê³„ë§Œ</option>
              <option value="shoring">ì‹œìŠ¤í…œë™ë°”ë¦¬ë§Œ</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ë©”ëª¨</label>
            <textarea id="notes" rows="2"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
              placeholder="íŠ¹ì´ì‚¬í•­ ë©”ëª¨"></textarea>
          </div>

          <button type="submit"
            class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all shadow-lg">
            ğŸ”‘ ë¼ì´ì„ ìŠ¤ ë°œê¸‰
          </button>
        </form>
      </div>

      <!-- ëª©ë¡ -->
      <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800">
            ğŸ“‹ ë°œê¸‰ ëª©ë¡ <span id="licenseCount" class="text-sm font-normal text-gray-500">(0ê±´)</span>
          </h2>
          
          <div class="flex gap-2">
            <input type="text" id="searchInput" placeholder="ê²€ìƒ‰..."
              class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
            <button onclick="loadLicenses()" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">ğŸ”</button>
            <button onclick="loadLicenses()" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">ğŸ”„</button>
          </div>
        </div>

        <div id="licenseList" class="overflow-x-auto">
          <p class="text-center text-gray-500 py-8">ë¡œë”© ì¤‘...</p>
        </div>
      </div>
    </div>

    <!-- ë°œê¸‰ ì™„ë£Œ ëª¨ë‹¬ -->
    <div id="modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
        <div class="text-center">
          <div class="text-6xl mb-4">ğŸ‰</div>
          <h3 class="text-2xl font-bold mb-2">ë¼ì´ì„ ìŠ¤ ë°œê¸‰ ì™„ë£Œ!</h3>
          <p class="text-gray-600 mb-6">ì•„ë˜ ë¼ì´ì„ ìŠ¤ í‚¤ë¥¼ ê³ ê°ì—ê²Œ ì „ë‹¬í•˜ì„¸ìš”.</p>
          
          <div class="bg-gray-100 rounded-xl p-4 mb-6">
            <code id="generatedKey" class="text-2xl font-bold text-green-600"></code>
          </div>
          
          <div class="flex gap-3">
            <button onclick="copyKey()" class="flex-1 py-3 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600">
              ğŸ“‹ ë³µì‚¬
            </button>
            <button onclick="closeModal()" class="flex-1 py-3 bg-gray-200 text-gray-800 font-bold rounded-lg hover:bg-gray-300">
              ë‹«ê¸°
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Supabase ì„¤ì •
    const SUPABASE_URL = 'https://uyrbyahnudzkptmnxwdi.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_OOctZqKX0pky_tWpV_xNAA_xuIego1Z';
    
    // ë¼ì´ì„ ìŠ¤ í‚¤ ìƒì„± ì‹œí¬ë¦¿
    const SECRET = 'GASEOL_PARTNER_2025';
    
    // Supabase í´ë¼ì´ì–¸íŠ¸
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ë¼ì´ì„ ìŠ¤ í‚¤ ìƒì„±
    async function generateLicenseKey(hardwareId) {
      const normalized = hardwareId.trim().toUpperCase();
      const data = new TextEncoder().encode(normalized + SECRET);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      const key = hashHex.substring(0, 16).toUpperCase();
      return key.match(/.{4}/g).join('-');
    }
    
    // ë¼ì´ì„ ìŠ¤ ëª©ë¡ ë¡œë“œ
    async function loadLicenses() {
      const search = document.getElementById('searchInput').value;
      
      try {
        let query = db
          .from('licenses')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (search) {
          query = query.or(`customer_name.ilike.%${search}%,hardware_id.ilike.%${search}%,company_name.ilike.%${search}%`);
        }
        
        const { data, error } = await query;
        
        if (error) throw error;
        
        document.getElementById('licenseCount').textContent = `(${data.length}ê±´)`;
        
        if (data.length === 0) {
          document.getElementById('licenseList').innerHTML = '<p class="text-center text-gray-500 py-8">ë°œê¸‰ëœ ë¼ì´ì„ ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        let html = `
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-gray-200 text-left">
                <th class="py-3 px-2">ê³ ê°</th>
                <th class="py-3 px-2">í•˜ë“œì›¨ì–´ ID</th>
                <th class="py-3 px-2">ë¼ì´ì„ ìŠ¤ í‚¤</th>
                <th class="py-3 px-2">ì œí’ˆ</th>
                <th class="py-3 px-2">ìƒíƒœ</th>
                <th class="py-3 px-2">ë°œê¸‰ì¼</th>
                <th class="py-3 px-2">ì‘ì—…</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        data.forEach(license => {
          const productLabel = license.product_type === 'all' ? 'ì „ì²´' : 
                              license.product_type === 'scaffold' ? 'ë¹„ê³„' : 'ë™ë°”ë¦¬';
          const productColor = license.product_type === 'all' ? 'bg-purple-100 text-purple-800' : 
                              license.product_type === 'scaffold' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800';
          
          html += `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
              <td class="py-3 px-2">
                <div class="font-medium">${license.customer_name}</div>
                ${license.company_name ? `<div class="text-xs text-gray-500">${license.company_name}</div>` : ''}
              </td>
              <td class="py-3 px-2">
                <code class="text-xs bg-gray-100 px-2 py-1 rounded">${license.hardware_id}</code>
              </td>
              <td class="py-3 px-2">
                <div class="flex items-center gap-1">
                  <code class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded font-bold">${license.license_key}</code>
                  <button onclick="copyToClipboard('${license.license_key}')" class="text-gray-400 hover:text-gray-600" title="ë³µì‚¬">ğŸ“‹</button>
                </div>
              </td>
              <td class="py-3 px-2">
                <span class="text-xs px-2 py-1 rounded ${productColor}">${productLabel}</span>
              </td>
              <td class="py-3 px-2">
                <button onclick="toggleActive('${license.id}', ${license.is_active})" 
                  class="text-xs px-2 py-1 rounded ${license.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                  ${license.is_active ? 'âœ… í™œì„±' : 'âŒ ë¹„í™œì„±'}
                </button>
              </td>
              <td class="py-3 px-2 text-xs text-gray-500">
                ${new Date(license.created_at).toLocaleDateString('ko-KR')}
              </td>
              <td class="py-3 px-2">
                <button onclick="deleteLicense('${license.id}')" class="text-red-500 hover:text-red-700 text-xs">ğŸ—‘ï¸</button>
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        document.getElementById('licenseList').innerHTML = html;
        
      } catch (error) {
        console.error('ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('licenseList').innerHTML = `<p class="text-center text-red-500 py-8">ì˜¤ë¥˜: ${error.message}</p>`;
      }
    }
    
    // ë¼ì´ì„ ìŠ¤ ë°œê¸‰
    document.getElementById('licenseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const customer_name = document.getElementById('customer_name').value;
      const hardware_id = document.getElementById('hardware_id').value.toUpperCase();
      const company_name = document.getElementById('company_name').value;
      const customer_phone = document.getElementById('customer_phone').value;
      const customer_email = document.getElementById('customer_email').value;
      const product_type = document.getElementById('product_type').value;
      const notes = document.getElementById('notes').value;
      
      if (hardware_id.length !== 16) {
        alert('í•˜ë“œì›¨ì–´ IDëŠ” 16ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      
      try {
        // ì¤‘ë³µ ì²´í¬
        const { data: existing } = await db
          .from('licenses')
          .select('id')
          .eq('hardware_id', hardware_id)
          .single();
        
        if (existing) {
          alert('ì´ë¯¸ ë“±ë¡ëœ í•˜ë“œì›¨ì–´ IDì…ë‹ˆë‹¤.');
          return;
        }
        
        // ë¼ì´ì„ ìŠ¤ í‚¤ ìƒì„±
        const license_key = await generateLicenseKey(hardware_id);
        
        // DB ì €ì¥
        const { error } = await db
          .from('licenses')
          .insert({
            customer_name,
            hardware_id,
            license_key,
            company_name: company_name || null,
            customer_phone: customer_phone || null,
            customer_email: customer_email || null,
            product_type,
            notes: notes || null,
            is_active: true
          });
        
        if (error) throw error;
        
        // ëª¨ë‹¬ í‘œì‹œ
        document.getElementById('generatedKey').textContent = license_key;
        document.getElementById('modal').classList.remove('hidden');
        
        // í¼ ì´ˆê¸°í™”
        document.getElementById('licenseForm').reset();
        
        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        loadLicenses();
        
      } catch (error) {
        console.error('ë°œê¸‰ ì˜¤ë¥˜:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    });
    
    // í™œì„±/ë¹„í™œì„± í† ê¸€
    async function toggleActive(id, currentStatus) {
      try {
        const { error } = await db
          .from('licenses')
          .update({ is_active: !currentStatus })
          .eq('id', id);
        
        if (error) throw error;
        loadLicenses();
      } catch (error) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    // ë¼ì´ì„ ìŠ¤ ì‚­ì œ
    async function deleteLicense(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      try {
        const { error } = await db
          .from('licenses')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        loadLicenses();
      } catch (error) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    // í´ë¦½ë³´ë“œ ë³µì‚¬
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text);
      alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
    
    function copyKey() {
      const key = document.getElementById('generatedKey').textContent;
      navigator.clipboard.writeText(key);
      alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
    
    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
    }
    
    // ê²€ìƒ‰ ì—”í„°í‚¤
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loadLicenses();
    });
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª©ë¡ ë¡œë“œ
    loadLicenses();
  </script>
</body>
</html>
