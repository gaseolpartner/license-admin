<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”‘ ê°€ì„¤íŒŒíŠ¸ë„ˆ ë¼ì´ì„ ìŠ¤ ê´€ë¦¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .tab-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app" class="container mx-auto px-4 py-8 max-w-6xl">
    
    <!-- í—¤ë” -->
    <div class="mb-6 text-center">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ”‘ ê°€ì„¤íŒŒíŠ¸ë„ˆ ë¼ì´ì„ ìŠ¤ ê´€ë¦¬</h1>
      <p class="text-gray-600">ìŠ¤ì¼€ì¹˜ì—… í”ŒëŸ¬ê·¸ì¸ / ë…¸ë¬´ëŒ€ì¥ ë¼ì´ì„ ìŠ¤ ë°œê¸‰ ë° ê´€ë¦¬</p>
    </div>

    <!-- íƒ­ ë²„íŠ¼ -->
    <div class="flex justify-center mb-6">
      <div class="bg-white rounded-xl p-1 shadow-lg inline-flex gap-1">
        <button onclick="switchTab('sketchup')" id="tab-sketchup" class="tab-btn active px-6 py-3 rounded-lg font-bold transition-all">
          ğŸ—ï¸ ìŠ¤ì¼€ì¹˜ì—… í”ŒëŸ¬ê·¸ì¸
        </button>
        <button onclick="switchTab('nomu')" id="tab-nomu" class="tab-btn px-6 py-3 rounded-lg font-bold transition-all hover:bg-gray-100">
          ğŸ“‹ ë…¸ë¬´ëŒ€ì¥
        </button>
      </div>
    </div>

    <!-- ============================================== -->
    <!-- ìŠ¤ì¼€ì¹˜ì—… í”ŒëŸ¬ê·¸ì¸ íƒ­ -->
    <!-- ============================================== -->
    <div id="content-sketchup" class="tab-content active">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- ë°œê¸‰ í¼ -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
          <h2 class="text-xl font-bold mb-6 text-gray-800">âœ¨ ìƒˆ ë¼ì´ì„ ìŠ¤ ë°œê¸‰</h2>
          
          <form id="licenseForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ê³ ê°ëª… *</label>
              <input type="text" id="customer_name" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
                placeholder="í™ê¸¸ë™">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">íšŒì‚¬ëª…</label>
              <input type="text" id="company_name"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
                placeholder="(ì£¼)ê°€ì„¤ê±´ì„¤">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">í•˜ë“œì›¨ì–´ ID *</label>
              <input type="text" id="hardware_id" required maxlength="16"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none font-mono uppercase"
                placeholder="A1B2C3D4E5F6G7H8"
                oninput="this.value = this.value.toUpperCase()">
              <p class="text-xs text-gray-500 mt-1">16ìë¦¬ ì˜ìˆ«ì (ê³ ê° í”„ë¡œê·¸ë¨ì—ì„œ í™•ì¸)</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ì—°ë½ì²˜</label>
              <input type="tel" id="customer_phone"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
                placeholder="010-1234-5678">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë©”ì¼</label>
              <input type="email" id="customer_email"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
                placeholder="customer@email.com">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ì œí’ˆ ìœ í˜•</label>
              <select id="product_type"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none">
                <option value="all">ì „ì²´ (ë¹„ê³„+ë™ë°”ë¦¬)</option>
                <option value="scaffold">ì‹œìŠ¤í…œë¹„ê³„ë§Œ</option>
                <option value="shoring">ì‹œìŠ¤í…œë™ë°”ë¦¬ë§Œ</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ë©”ëª¨</label>
              <textarea id="notes" rows="2"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
                placeholder="íŠ¹ì´ì‚¬í•­ ë©”ëª¨"></textarea>
            </div>

            <button type="submit"
              class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all shadow-lg">
              ğŸ”‘ ë¼ì´ì„ ìŠ¤ ë°œê¸‰
            </button>
          </form>
        </div>

        <!-- ëª©ë¡ -->
        <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-gray-800">
              ğŸ“‹ ë°œê¸‰ ëª©ë¡ <span id="licenseCount" class="text-sm font-normal text-gray-500">(0ê±´)</span>
            </h2>
            
            <div class="flex gap-2">
              <input type="text" id="searchInput" placeholder="ê²€ìƒ‰..."
                class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
              <button onclick="loadLicenses()" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">ğŸ”„</button>
            </div>
          </div>

          <div id="licenseList" class="overflow-x-auto">
            <p class="text-center text-gray-500 py-8">ë¡œë”© ì¤‘...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================== -->
    <!-- ë…¸ë¬´ëŒ€ì¥ íƒ­ -->
    <!-- ============================================== -->
    <div id="content-nomu" class="tab-content">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- ë…¸ë¬´ëŒ€ì¥ ë°œê¸‰ í¼ -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
          <h2 class="text-xl font-bold mb-6 text-gray-800">âœ¨ ë…¸ë¬´ëŒ€ì¥ ë¼ì´ì„ ìŠ¤ ë°œê¸‰</h2>
          
          <form id="nomuLicenseForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">íšŒì‚¬ëª… *</label>
              <input type="text" id="nomu_company_name" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                placeholder="(ì£¼)ê°€ì„¤ê±´ì„¤">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ì‚¬ìš©ìëª… *</label>
              <input type="text" id="nomu_user_name" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                placeholder="í™ê¸¸ë™">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ì—°ë½ì²˜</label>
              <input type="tel" id="nomu_phone"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                placeholder="010-1234-5678">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë©”ì¼</label>
              <input type="email" id="nomu_email"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                placeholder="customer@email.com">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ë¼ì´ì„ ìŠ¤ íƒ€ì…</label>
              <select id="nomu_license_type" onchange="updateNomuDuration()"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                <option value="monthly">ì›”ê°„ (30ì¼)</option>
                <option value="yearly">ì—°ê°„ (365ì¼)</option>
                <option value="permanent">ì˜êµ¬</option>
              </select>
            </div>

            <div id="nomu_duration_group">
              <label class="block text-sm font-medium text-gray-700 mb-1">ê¸°ê°„ (ì¼)</label>
              <input type="number" id="nomu_duration" value="30" min="1"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ë©”ëª¨</label>
              <textarea id="nomu_notes" rows="2"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                placeholder="íŠ¹ì´ì‚¬í•­ ë©”ëª¨"></textarea>
            </div>

            <button type="submit"
              class="w-full py-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all shadow-lg">
              ğŸ”‘ ë¼ì´ì„ ìŠ¤ ë°œê¸‰
            </button>
          </form>
        </div>

        <!-- ë…¸ë¬´ëŒ€ì¥ ëª©ë¡ -->
        <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-gray-800">
              ğŸ“‹ ë…¸ë¬´ëŒ€ì¥ ë¼ì´ì„ ìŠ¤ <span id="nomuLicenseCount" class="text-sm font-normal text-gray-500">(0ê±´)</span>
            </h2>
            
            <div class="flex gap-2">
              <select id="nomuStatusFilter" onchange="loadNomuLicenses()" 
                class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none">
                <option value="all">ì „ì²´ ìƒíƒœ</option>
                <option value="active">í™œì„±</option>
                <option value="pending">ëŒ€ê¸°</option>
                <option value="expired">ë§Œë£Œ</option>
                <option value="revoked">ì·¨ì†Œ</option>
              </select>
              <input type="text" id="nomuSearchInput" placeholder="ê²€ìƒ‰..."
                class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
              <button onclick="loadNomuLicenses()" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">ğŸ”„</button>
            </div>
          </div>

          <!-- í†µê³„ ì¹´ë“œ -->
          <div class="grid grid-cols-4 gap-3 mb-6">
            <div class="bg-gray-50 rounded-lg p-3 text-center">
              <div id="nomu-stat-total" class="text-2xl font-bold text-gray-700">0</div>
              <div class="text-xs text-gray-500">ì „ì²´</div>
            </div>
            <div class="bg-green-50 rounded-lg p-3 text-center">
              <div id="nomu-stat-active" class="text-2xl font-bold text-green-600">0</div>
              <div class="text-xs text-gray-500">í™œì„±</div>
            </div>
            <div class="bg-yellow-50 rounded-lg p-3 text-center">
              <div id="nomu-stat-pending" class="text-2xl font-bold text-yellow-600">0</div>
              <div class="text-xs text-gray-500">ëŒ€ê¸°</div>
            </div>
            <div class="bg-red-50 rounded-lg p-3 text-center">
              <div id="nomu-stat-expired" class="text-2xl font-bold text-red-600">0</div>
              <div class="text-xs text-gray-500">ë§Œë£Œ</div>
            </div>
          </div>

          <div id="nomuLicenseList" class="overflow-x-auto">
            <p class="text-center text-gray-500 py-8">ë¡œë”© ì¤‘...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ë°œê¸‰ ì™„ë£Œ ëª¨ë‹¬ (ìŠ¤ì¼€ì¹˜ì—…) -->
    <div id="modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
        <div class="text-center">
          <div class="text-6xl mb-4">ğŸ‰</div>
          <h3 class="text-2xl font-bold mb-2">ë¼ì´ì„ ìŠ¤ ë°œê¸‰ ì™„ë£Œ!</h3>
          <p class="text-gray-600 mb-6">ì•„ë˜ ë¼ì´ì„ ìŠ¤ í‚¤ë¥¼ ê³ ê°ì—ê²Œ ì „ë‹¬í•˜ì„¸ìš”.</p>
          
          <div class="bg-gray-100 rounded-xl p-4 mb-6">
            <code id="generatedKey" class="text-2xl font-bold text-green-600"></code>
          </div>
          
          <div class="flex gap-3">
            <button onclick="copyKey()" class="flex-1 py-3 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600">
              ğŸ“‹ ë³µì‚¬
            </button>
            <button onclick="closeModal()" class="flex-1 py-3 bg-gray-200 text-gray-800 font-bold rounded-lg hover:bg-gray-300">
              ë‹«ê¸°
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ë°œê¸‰ ì™„ë£Œ ëª¨ë‹¬ (ë…¸ë¬´ëŒ€ì¥) -->
    <div id="nomuModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
        <div class="text-center">
          <div class="text-6xl mb-4">ğŸ‰</div>
          <h3 class="text-2xl font-bold mb-2">ë…¸ë¬´ëŒ€ì¥ ë¼ì´ì„ ìŠ¤ ë°œê¸‰!</h3>
          <p class="text-gray-600 mb-6">ì•„ë˜ ë¼ì´ì„ ìŠ¤ í‚¤ë¥¼ ê³ ê°ì—ê²Œ ì „ë‹¬í•˜ì„¸ìš”.</p>
          
          <div class="bg-purple-50 rounded-xl p-4 mb-4">
            <code id="nomuGeneratedKey" class="text-2xl font-bold text-purple-600"></code>
          </div>
          
          <div id="nomuExpiryInfo" class="text-sm text-gray-600 mb-6"></div>
          
          <div class="flex gap-3">
            <button onclick="copyNomuKey()" class="flex-1 py-3 bg-purple-500 text-white font-bold rounded-lg hover:bg-purple-600">
              ğŸ“‹ ë³µì‚¬
            </button>
            <button onclick="closeNomuModal()" class="flex-1 py-3 bg-gray-200 text-gray-800 font-bold rounded-lg hover:bg-gray-300">
              ë‹«ê¸°
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- PC ë¦¬ì…‹ í™•ì¸ ëª¨ë‹¬ -->
    <div id="resetModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
        <div class="text-center">
          <div class="text-6xl mb-4">ğŸ”„</div>
          <h3 class="text-2xl font-bold mb-2">PC ë“±ë¡ í•´ì œ</h3>
          <p class="text-gray-600 mb-6">ì´ ë¼ì´ì„ ìŠ¤ì˜ PC ë“±ë¡ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì‚¬ìš©ìê°€ ìƒˆ PCì—ì„œ ë‹¤ì‹œ í™œì„±í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          
          <div class="flex gap-3">
            <button onclick="confirmResetMachine()" class="flex-1 py-3 bg-orange-500 text-white font-bold rounded-lg hover:bg-orange-600">
              í•´ì œí•˜ê¸°
            </button>
            <button onclick="closeResetModal()" class="flex-1 py-3 bg-gray-200 text-gray-800 font-bold rounded-lg hover:bg-gray-300">
              ì·¨ì†Œ
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ============================================
    // Supabase ì„¤ì •
    // ============================================
    const SUPABASE_URL = 'https://uyrbyahnudzkptmnxwdi.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5cmJ5YWhudWR6a3B0bW54d2RpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0OTgxODcsImV4cCI6MjA4MTA3NDE4N30.oYto7MDhhfC6IovWfBUJzIsgA72YeFHJ82YM3gkskPo';
    
    const SECRET = 'GASEOL_PARTNER_2025';
    
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ============================================
    // íƒ­ ì „í™˜
    // ============================================
    function switchTab(tab) {
      // ë²„íŠ¼ ìŠ¤íƒ€ì¼
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`tab-${tab}`).classList.add('active');
      
      // ì»¨í…ì¸  í‘œì‹œ
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`content-${tab}`).classList.add('active');
      
      // ë°ì´í„° ë¡œë“œ
      if (tab === 'nomu') {
        loadNomuLicenses();
      }
    }
    
    // ============================================
    // ìŠ¤ì¼€ì¹˜ì—… ë¼ì´ì„ ìŠ¤ (ê¸°ì¡´)
    // ============================================
    async function generateLicenseKey(hardwareId) {
      const normalized = hardwareId.trim().toUpperCase();
      const data = new TextEncoder().encode(normalized + SECRET);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      const key = hashHex.substring(0, 16).toUpperCase();
      return key.match(/.{4}/g).join('-');
    }
    
    async function loadLicenses() {
      const search = document.getElementById('searchInput').value;
      
      try {
        let query = db
          .from('licenses')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (search) {
          query = query.or(`customer_name.ilike.%${search}%,hardware_id.ilike.%${search}%,company_name.ilike.%${search}%`);
        }
        
        const { data, error } = await query;
        
        if (error) throw error;
        
        document.getElementById('licenseCount').textContent = `(${data.length}ê±´)`;
        
        if (data.length === 0) {
          document.getElementById('licenseList').innerHTML = '<p class="text-center text-gray-500 py-8">ë°œê¸‰ëœ ë¼ì´ì„ ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        let html = `
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-gray-200 text-left">
                <th class="py-3 px-2">ê³ ê°</th>
                <th class="py-3 px-2">í•˜ë“œì›¨ì–´ ID</th>
                <th class="py-3 px-2">ë¼ì´ì„ ìŠ¤ í‚¤</th>
                <th class="py-3 px-2">ì œí’ˆ</th>
                <th class="py-3 px-2">ìƒíƒœ</th>
                <th class="py-3 px-2">ë°œê¸‰ì¼</th>
                <th class="py-3 px-2">ì‘ì—…</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        data.forEach(license => {
          const productLabel = license.product_type === 'all' ? 'ì „ì²´' : 
                              license.product_type === 'scaffold' ? 'ë¹„ê³„' : 'ë™ë°”ë¦¬';
          const productColor = license.product_type === 'all' ? 'bg-purple-100 text-purple-800' : 
                              license.product_type === 'scaffold' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800';
          
          html += `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
              <td class="py-3 px-2">
                <div class="font-medium">${license.customer_name}</div>
                ${license.company_name ? `<div class="text-xs text-gray-500">${license.company_name}</div>` : ''}
              </td>
              <td class="py-3 px-2">
                <code class="text-xs bg-gray-100 px-2 py-1 rounded">${license.hardware_id}</code>
              </td>
              <td class="py-3 px-2">
                <div class="flex items-center gap-1">
                  <code class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded font-bold">${license.license_key}</code>
                  <button onclick="copyToClipboard('${license.license_key}')" class="text-gray-400 hover:text-gray-600" title="ë³µì‚¬">ğŸ“‹</button>
                </div>
              </td>
              <td class="py-3 px-2">
                <span class="text-xs px-2 py-1 rounded ${productColor}">${productLabel}</span>
              </td>
              <td class="py-3 px-2">
                <button onclick="toggleActive('${license.id}', ${license.is_active})" 
                  class="text-xs px-2 py-1 rounded ${license.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                  ${license.is_active ? 'âœ… í™œì„±' : 'âŒ ë¹„í™œì„±'}
                </button>
              </td>
              <td class="py-3 px-2 text-xs text-gray-500">
                ${new Date(license.created_at).toLocaleDateString('ko-KR')}
              </td>
              <td class="py-3 px-2">
                <button onclick="deleteLicense('${license.id}')" class="text-red-500 hover:text-red-700 text-xs">ğŸ—‘ï¸</button>
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        document.getElementById('licenseList').innerHTML = html;
        
      } catch (error) {
        console.error('ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('licenseList').innerHTML = `<p class="text-center text-red-500 py-8">ì˜¤ë¥˜: ${error.message}</p>`;
      }
    }
    
    document.getElementById('licenseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const customer_name = document.getElementById('customer_name').value;
      const hardware_id = document.getElementById('hardware_id').value.toUpperCase();
      const company_name = document.getElementById('company_name').value;
      const customer_phone = document.getElementById('customer_phone').value;
      const customer_email = document.getElementById('customer_email').value;
      const product_type = document.getElementById('product_type').value;
      const notes = document.getElementById('notes').value;
      
      if (hardware_id.length !== 16) {
        alert('í•˜ë“œì›¨ì–´ IDëŠ” 16ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      
      try {
        const { data: existing } = await db
          .from('licenses')
          .select('id')
          .eq('hardware_id', hardware_id)
          .single();
        
        if (existing) {
          alert('ì´ë¯¸ ë“±ë¡ëœ í•˜ë“œì›¨ì–´ IDì…ë‹ˆë‹¤.');
          return;
        }
        
        const license_key = await generateLicenseKey(hardware_id);
        
        const { error } = await db
          .from('licenses')
          .insert({
            customer_name,
            hardware_id,
            license_key,
            company_name: company_name || null,
            customer_phone: customer_phone || null,
            customer_email: customer_email || null,
            product_type,
            notes: notes || null,
            is_active: true
          });
        
        if (error) throw error;
        
        document.getElementById('generatedKey').textContent = license_key;
        document.getElementById('modal').classList.remove('hidden');
        document.getElementById('licenseForm').reset();
        loadLicenses();
        
      } catch (error) {
        console.error('ë°œê¸‰ ì˜¤ë¥˜:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    });
    
    async function toggleActive(id, currentStatus) {
      try {
        const { error } = await db
          .from('licenses')
          .update({ is_active: !currentStatus })
          .eq('id', id);
        
        if (error) throw error;
        loadLicenses();
      } catch (error) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    async function deleteLicense(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      try {
        const { error } = await db
          .from('licenses')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        loadLicenses();
      } catch (error) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text);
      alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
    
    function copyKey() {
      const key = document.getElementById('generatedKey').textContent;
      navigator.clipboard.writeText(key);
      alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
    
    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
    }
    
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loadLicenses();
    });
    
    // ============================================
    // ë…¸ë¬´ëŒ€ì¥ ë¼ì´ì„ ìŠ¤
    // ============================================
    function updateNomuDuration() {
      const type = document.getElementById('nomu_license_type').value;
      const durationGroup = document.getElementById('nomu_duration_group');
      const durationInput = document.getElementById('nomu_duration');
      
      if (type === 'permanent') {
        durationGroup.style.display = 'none';
        durationInput.value = 36500;
      } else if (type === 'yearly') {
        durationGroup.style.display = 'block';
        durationInput.value = 365;
      } else {
        durationGroup.style.display = 'block';
        durationInput.value = 30;
      }
    }
    
    async function loadNomuLicenses() {
      const search = document.getElementById('nomuSearchInput').value;
      const statusFilter = document.getElementById('nomuStatusFilter').value;
      
      try {
        let query = db
          .from('nomu_licenses')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (statusFilter !== 'all') {
          query = query.eq('status', statusFilter);
        }
        
        if (search) {
          query = query.or(`license_key.ilike.%${search}%,company_name.ilike.%${search}%,user_name.ilike.%${search}%`);
        }
        
        const { data, error } = await query;
        
        if (error) throw error;
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        const allData = await db.from('nomu_licenses').select('status');
        if (allData.data) {
          document.getElementById('nomu-stat-total').textContent = allData.data.length;
          document.getElementById('nomu-stat-active').textContent = allData.data.filter(l => l.status === 'active').length;
          document.getElementById('nomu-stat-pending').textContent = allData.data.filter(l => l.status === 'pending').length;
          document.getElementById('nomu-stat-expired').textContent = allData.data.filter(l => l.status === 'expired').length;
        }
        
        document.getElementById('nomuLicenseCount').textContent = `(${data.length}ê±´)`;
        
        if (data.length === 0) {
          document.getElementById('nomuLicenseList').innerHTML = '<p class="text-center text-gray-500 py-8">ë°œê¸‰ëœ ë¼ì´ì„ ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        let html = `
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-gray-200 text-left">
                <th class="py-3 px-2">ë¼ì´ì„ ìŠ¤ í‚¤</th>
                <th class="py-3 px-2">íšŒì‚¬/ì‚¬ìš©ì</th>
                <th class="py-3 px-2">íƒ€ì…</th>
                <th class="py-3 px-2">ìƒíƒœ</th>
                <th class="py-3 px-2">ë§Œë£Œì¼</th>
                <th class="py-3 px-2">PC</th>
                <th class="py-3 px-2">ì‘ì—…</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        data.forEach(license => {
          const statusColors = {
            pending: 'bg-yellow-100 text-yellow-800',
            active: 'bg-green-100 text-green-800',
            expired: 'bg-red-100 text-red-800',
            revoked: 'bg-gray-100 text-gray-800'
          };
          const statusLabels = {
            pending: 'ëŒ€ê¸°',
            active: 'í™œì„±',
            expired: 'ë§Œë£Œ',
            revoked: 'ì·¨ì†Œ'
          };
          const typeLabels = {
            monthly: 'ì›”ê°„',
            yearly: 'ì—°ê°„',
            permanent: 'ì˜êµ¬'
          };
          
          // ë‚¨ì€ ì¼ìˆ˜ ê³„ì‚°
          let daysRemaining = '';
          if (license.expires_at) {
            const now = new Date();
            const expiry = new Date(license.expires_at);
            const diff = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
            if (diff < 0) {
              daysRemaining = `<span class="text-red-500">${Math.abs(diff)}ì¼ ê²½ê³¼</span>`;
            } else if (diff <= 7) {
              daysRemaining = `<span class="text-orange-500">${diff}ì¼ ë‚¨ìŒ</span>`;
            } else {
              daysRemaining = `<span class="text-green-500">${diff}ì¼ ë‚¨ìŒ</span>`;
            }
          } else {
            daysRemaining = '<span class="text-gray-500">ë¬´ì œí•œ</span>';
          }
          
          html += `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
              <td class="py-3 px-2">
                <div class="flex items-center gap-1">
                  <code class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded font-bold">${license.license_key}</code>
                  <button onclick="copyToClipboard('${license.license_key}')" class="text-gray-400 hover:text-gray-600">ğŸ“‹</button>
                </div>
              </td>
              <td class="py-3 px-2">
                <div class="font-medium">${license.company_name || '-'}</div>
                <div class="text-xs text-gray-500">${license.user_name || '-'}</div>
              </td>
              <td class="py-3 px-2">
                <span class="text-xs">${typeLabels[license.license_type] || license.license_type}</span>
              </td>
              <td class="py-3 px-2">
                <span class="text-xs px-2 py-1 rounded ${statusColors[license.status]}">${statusLabels[license.status]}</span>
              </td>
              <td class="py-3 px-2 text-xs">
                ${license.expires_at ? new Date(license.expires_at).toLocaleDateString('ko-KR') : 'ë¬´ì œí•œ'}<br>
                ${daysRemaining}
              </td>
              <td class="py-3 px-2">
                ${license.machine_id ? `
                  <span class="text-green-500 text-xs">âœ… ë“±ë¡</span>
                  <button onclick="showResetModal('${license.license_key}')" class="text-orange-500 hover:text-orange-700 text-xs ml-1" title="PC í•´ì œ">ğŸ”„</button>
                ` : '<span class="text-gray-400 text-xs">ë¯¸ë“±ë¡</span>'}
              </td>
              <td class="py-3 px-2">
                <div class="flex gap-1">
                  <button onclick="extendNomuLicense('${license.id}', 30)" class="text-blue-500 hover:text-blue-700 text-xs" title="+30ì¼">â•</button>
                  ${license.status !== 'revoked' ? `
                    <button onclick="revokeNomuLicense('${license.id}')" class="text-red-500 hover:text-red-700 text-xs" title="ì·¨ì†Œ">ğŸš«</button>
                  ` : ''}
                </div>
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        document.getElementById('nomuLicenseList').innerHTML = html;
        
      } catch (error) {
        console.error('ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('nomuLicenseList').innerHTML = `<p class="text-center text-red-500 py-8">ì˜¤ë¥˜: ${error.message}</p>`;
      }
    }
    
    // ë…¸ë¬´ëŒ€ì¥ ë¼ì´ì„ ìŠ¤ ë°œê¸‰
    document.getElementById('nomuLicenseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const company_name = document.getElementById('nomu_company_name').value;
      const user_name = document.getElementById('nomu_user_name').value;
      const user_phone = document.getElementById('nomu_phone').value;
      const user_email = document.getElementById('nomu_email').value;
      const license_type = document.getElementById('nomu_license_type').value;
      const duration = parseInt(document.getElementById('nomu_duration').value);
      const notes = document.getElementById('nomu_notes').value;
      
      try {
        const { data, error } = await db.rpc('generate_nomu_license', {
          p_company_name: company_name,
          p_user_name: user_name,
          p_user_email: user_email || null,
          p_user_phone: user_phone || null,
          p_license_type: license_type,
          p_duration_days: duration,
          p_notes: notes || null
        });
        
        if (error) throw error;
        
        if (data.success) {
          document.getElementById('nomuGeneratedKey').textContent = data.license_key;
          document.getElementById('nomuExpiryInfo').textContent = data.expires_at 
            ? `ë§Œë£Œì¼: ${new Date(data.expires_at).toLocaleDateString('ko-KR')}` 
            : 'ì˜êµ¬ ë¼ì´ì„ ìŠ¤';
          document.getElementById('nomuModal').classList.remove('hidden');
          document.getElementById('nomuLicenseForm').reset();
          loadNomuLicenses();
        } else {
          throw new Error(data.error || 'ë°œê¸‰ ì‹¤íŒ¨');
        }
        
      } catch (error) {
        console.error('ë°œê¸‰ ì˜¤ë¥˜:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    });
    
    // ë…¸ë¬´ëŒ€ì¥ ë¼ì´ì„ ìŠ¤ ì—°ì¥
    async function extendNomuLicense(id, days) {
      if (!confirm(`${days}ì¼ ì—°ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      
      try {
        // í˜„ì¬ ë¼ì´ì„ ìŠ¤ ì¡°íšŒ
        const { data: license, error: fetchError } = await db
          .from('nomu_licenses')
          .select('expires_at')
          .eq('id', id)
          .single();
        
        if (fetchError) throw fetchError;
        
        const currentExpiry = license.expires_at ? new Date(license.expires_at) : new Date();
        const newExpiry = new Date(currentExpiry);
        newExpiry.setDate(newExpiry.getDate() + days);
        
        const { error } = await db
          .from('nomu_licenses')
          .update({ 
            expires_at: newExpiry.toISOString(),
            status: 'active'
          })
          .eq('id', id);
        
        if (error) throw error;
        
        alert(`${days}ì¼ ì—°ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\nìƒˆ ë§Œë£Œì¼: ${newExpiry.toLocaleDateString('ko-KR')}`);
        loadNomuLicenses();
        
      } catch (error) {
        console.error('ì—°ì¥ ì‹¤íŒ¨:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    // ë…¸ë¬´ëŒ€ì¥ ë¼ì´ì„ ìŠ¤ ì·¨ì†Œ
    async function revokeNomuLicense(id) {
      if (!confirm('ì´ ë¼ì´ì„ ìŠ¤ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      try {
        const { error } = await db
          .from('nomu_licenses')
          .update({ status: 'revoked' })
          .eq('id', id);
        
        if (error) throw error;
        loadNomuLicenses();
        
      } catch (error) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    // PC ë¦¬ì…‹
    let resetLicenseKey = '';
    
    function showResetModal(licenseKey) {
      resetLicenseKey = licenseKey;
      document.getElementById('resetModal').classList.remove('hidden');
    }
    
    function closeResetModal() {
      document.getElementById('resetModal').classList.add('hidden');
      resetLicenseKey = '';
    }
    
    async function confirmResetMachine() {
      try {
        const { data, error } = await db.rpc('reset_nomu_machine', {
          p_license_key: resetLicenseKey
        });
        
        if (error) throw error;
        
        if (data.success) {
          alert('PC ë“±ë¡ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeResetModal();
          loadNomuLicenses();
        } else {
          throw new Error(data.error);
        }
        
      } catch (error) {
        console.error('ë¦¬ì…‹ ì‹¤íŒ¨:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }
    
    function copyNomuKey() {
      const key = document.getElementById('nomuGeneratedKey').textContent;
      navigator.clipboard.writeText(key);
      alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
    
    function closeNomuModal() {
      document.getElementById('nomuModal').classList.add('hidden');
    }
    
    document.getElementById('nomuSearchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loadNomuLicenses();
    });
    
    // ============================================
    // í˜ì´ì§€ ë¡œë“œ
    // ============================================
    loadLicenses();
  </script>
</body>
</html>
